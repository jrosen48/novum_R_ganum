---
title: "Visualizing a 2-way interaction (continuous moderator)"
author: "Nicholas Michalak"
date: "6/17/2017"
output: 
  html_document: 
    fig_height: 7.5
    fig_width: 10.5
    keep_md: yes
    theme: readable
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

# packages

```{r}
# packages I"ll want in this analysis
want_packages <- c("tidyverse", "lavaan", "probemod")

# which of those packages do I already have? (logical vector)
have_packages <- want_packages %in% rownames(installed.packages())

# if I don"t have any of those, install them
if(any(have_packages == FALSE)) install.packages(want_packages[have_packages == FALSE])

# load wanted packages
lapply(want_packages, library, character.only = TRUE)
```

# data

```{r}
# set randomizer seed
set.seed(1234)

# random normal data
# two-way interaction
x <- rnorm(n = 250, mean = 0, sd = )
z <- x * 0.4 + rnorm(n = 250, mean = 0, sd = 1)
y <- x * z + rnorm(n = 250, mean = 0, sd = 1)

# store in a dataframe
examp_dat <- data.frame(y, x, z)

# standardize z and then make a grouping variable for visualizing high and low z (standardized)
examp_dat <- examp_dat %>%
  mutate(z_std = as.numeric(scale(z)),
         x_z_std = x * z_std)
```

# models

```{r}

# without interaction term
examp_dat %>%
  lm(y ~ x + z_std, data = .) %>%
  summary(.)

# with interaction term
examp_dat %>%
  lm(y ~ x * z_std, data = .) %>%
  summary(.)

# simple slopes with predict
examp_dat %>%
  lm(y ~ x * z_std, data = .) %>%
  predict.lm(newdata = data.frame(z_std = mean(examp_dat$z_std) - sd(examp_dat$z_std)),
             se.fit = TRUE,
             interval = "confidence")

# simple slopes with sem
test_hi_low <- "# regressions
                  y ~ b1 * x
                  y ~ b2 * z_std
                  y ~ b3 * x_z_std

                # mean of z_std
                  z_std ~ z_std_mean * 1

                # variance of z_std
                  z_std ~~ z_std_var * z_std

                # simple slopes estimates
                  z_low := b1 + b3 * (z_std_mean - sqrt(z_std_var))
                  z_hi := b1 + b3 * (z_std_mean + sqrt(z_std_var))"

# fit model
test_hi_low %>%
  sem(data = examp_dat) %>%
  summary(.)

# select bootstrapped estimates
test_hi_low %>%
  sem(data = examp_dat) %>%
  parameterestimates(boot.ci.type = "bca.simple",
                     level = .95,
                     ci = TRUE,
                     standardized = FALSE) %>%
  filter(lhs == "y" & op != "~~" | op == ":=" & op != "~~")

# Johnson-Neyman
examp_dat %>%
  lm(y ~ x * z_std, data = .) %>%
  jn(dv = "y", iv = "x", mod = "z_std", alpha = .05)

```

# data for plotting simple slopes

```{r}
model_int <- examp_dat %>%
  lm(y ~ x * z_std, data = .)

low <- examp_dat %>%
  lm(y ~ x * z_std, data = .) %>%
  predict.lm(newdata = data.frame(x = x, z_std = mean(examp_dat$z_std) - sd(examp_dat$z_std)),
             se.fit = TRUE,
             interval = "confidence") %>%
  .$fit %>%
  data.frame(.)

avg <- examp_dat %>%
  lm(y ~ x * z_std, data = .) %>%
  predict.lm(newdata = data.frame(x = x, z_std = mean(examp_dat$z_std)),
             se.fit = TRUE,
             interval = "confidence") %>%
  .$fit %>%
  data.frame(.)

hi <- examp_dat %>%
  lm(y ~ x * z_std, data = .) %>%
  predict.lm(newdata = data.frame(x = x, z_std = mean(examp_dat$z_std) + sd(examp_dat$z_std)),
             se.fit = TRUE,
             interval = "confidence") %>%
  .$fit %>%
  data.frame(.)

examp_dat <- examp_dat %>%
  mutate(z_std_group = ifelse(z_std < (-1), -1,
                       ifelse(z_std > 1, 1, 0)),
         z_std_group = factor(z_std_group,
                              levels = c(-1, 0, 1),
                              labels = c("-1 SD", "0 SD", "+1 SD"),
                              ordered = TRUE),
         low_fit = as.numeric(low$fit),
         low_lwr = as.numeric(low$lwr),
         low_upr = as.numeric(low$upr),
         avg_fit = as.numeric(avg$fit),
         avg_lwr = as.numeric(avg$lwr),
         avg_upr = as.numeric(avg$upr),
         hi_fit = as.numeric(hi$fit),
         hi_lwr = as.numeric(hi$lwr),
         hi_upr = as.numeric(hi$upr))

```

# traditional plot
* can't see uncertainty in regression slopes
* can't see points
* can't see how z varies with x and y

```{r}
examp_dat %>%
  ggplot(mapping = aes(x = x, y = y)) +
  geom_line(aes(y = low_fit, linetype = "Low (-1 SD")) +
  geom_line(aes(y = hi_fit, linetype = "High (+1 SD")) +
  scale_x_continuous(breaks = seq(-4, 4, 1), limits = c(-4, 4)) +
  scale_y_continuous(breaks = seq(-5, 15, 5), limits = c(-5, 15)) +
  theme(legend.position = "top",
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)) +
  labs(linetype = "z_std")
```

# better plot
* includes uncertainty in regression slopes
* can't see points
* can't see how z varies with x and y

```{r}
examp_dat %>%
  ggplot(mapping = aes(x = x, y = y)) +
  geom_line(aes(y = low_fit, linetype = "Low (-1 SD")) +
  geom_line(aes(y = hi_fit, linetype = "High (+1 SD")) +
  geom_ribbon(aes(ymin = low_lwr, max = low_upr), alpha = 0.2) +
  geom_ribbon(aes(ymin = hi_lwr, max = hi_upr), alpha = 0.2) +
  scale_x_continuous(breaks = seq(-4, 4, 1), limits = c(-4, 4)) +
  scale_y_continuous(breaks = seq(-5, 15, 5), limits = c(-5, 15)) +
  theme(legend.position = "top",
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)) +
  labs(linetype = "z_std")
```

# even better plot
* includes uncertainty in regression slopes
* includes points
* can't see how z varies with x and y

```{r}
examp_dat %>%
  ggplot(mapping = aes(x = x, y = y)) +
  geom_point(alpha = 0.75) +
  geom_line(aes(y = low_fit, linetype = "Low (-1 SD")) +
  geom_line(aes(y = hi_fit, linetype = "High (+1 SD")) +
  geom_ribbon(aes(ymin = low_lwr, max = low_upr), alpha = 0.2) +
  geom_ribbon(aes(ymin = hi_lwr, max = hi_upr), alpha = 0.2) +
  scale_x_continuous(breaks = seq(-4, 4, 1), limits = c(-4, 4)) +
  scale_y_continuous(breaks = seq(-5, 15, 5), limits = c(-5, 15)) +
  theme(legend.position = "top",
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)) +
  labs(linetype = "z_std")
```

# my 1st recommended (2-dimensional) plot
* includes uncertainty in regression slopes
* includes points
* includes color gradient (light to dark) to depict how z varies with x and y

```{r}
examp_dat %>%
  ggplot(mapping = aes(x = x, y = y)) +
  geom_point(aes(color = z_std)) +
  geom_line(aes(y = low_fit, linetype = "Low (-1 SD")) +
  geom_line(aes(y = hi_fit, linetype = "High (+1 SD")) +
  geom_ribbon(aes(ymin = low_lwr, max = low_upr), alpha = 0.2) +
  geom_ribbon(aes(ymin = hi_lwr, max = hi_upr), alpha = 0.2) +
  scale_y_continuous(breaks = seq(-5, 15, 5), limits = c(-5, 15)) +
  scale_color_gradient(low = "white", high = "black") +
  theme(legend.position = "top",
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)) +
  labs(linetype = "z_std")
```

# my 2nd recommended (2-dimensional) plot
* includes uncertainty in regression slopes
* includes points
* includes marginal rug to depict how z varies along x and y

```{r}

examp_dat %>%
  ggplot(mapping = aes(x = x, y = y)) +
  geom_point(alpha = 0.75) +
  geom_line(aes(y = low_fit, linetype = "Low (-1 SD")) +
  geom_line(aes(y = hi_fit, linetype = "High (+1 SD")) +
  geom_ribbon(aes(ymin = low_lwr, max = low_upr), alpha = 0.2) +
  geom_ribbon(aes(ymin = hi_lwr, max = hi_upr), alpha = 0.2) +
  geom_rug(aes(x = z_std), sides = "b") +
  scale_x_continuous(breaks = seq(-4, 4, 1), limits = c(-4, 4)) +
  scale_y_continuous(breaks = seq(-5, 15, 5), limits = c(-5, 15)) +
  scale_color_gradient(low = "white", high = "black") +
  theme(legend.position = "top",
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)) +
  labs(linetype = "z_std")

```

# my 3rd recommended (2-dimensional) plot
* includes uncertainty in regression slopes
* includes points
* includes color gradient (light to dark) to depict how z varies with x and y
* includes slopes at multiple levels of z

```{r}
examp_dat %>%
  ggplot(mapping = aes(x = x, y = y)) +
  geom_point(aes(color = z_std)) +
  facet_wrap(~ z_std_group) +
  geom_line(data = examp_dat %>%
              filter(z_std_group == "-1 SD"), aes(y = low_fit, linetype = "Low (-1 SD)")) +
  geom_line(data = examp_dat %>%
              filter(z_std_group == "0 SD"), aes(y = avg_fit, linetype = "Mean (0 SD)")) +
  geom_line(data = examp_dat %>%
              filter(z_std_group == "+1 SD"), aes(y = hi_fit, linetype = "High (+1 SD)")) +
  geom_ribbon(data = examp_dat %>%
              filter(z_std_group == "-1 SD"), aes(ymin = low_lwr, ymax = low_upr), alpha = 0.2) +
  geom_ribbon(data = examp_dat %>%
              filter(z_std_group == "0 SD"), aes(ymin = avg_lwr, ymax = avg_upr), alpha = 0.2) +
  geom_ribbon(data = examp_dat %>%
              filter(z_std_group == "+1 SD"), aes(ymin = hi_lwr, ymax = hi_upr), alpha = 0.2) +
  scale_x_continuous(breaks = seq(-4, 4, 2), limits = c(-4, 4)) +
  scale_y_continuous(breaks = seq(-5, 15, 5), limits = c(-5, 15)) +
  scale_color_gradient(low = "white", high = "black") +
  theme(legend.position = "top",
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.title.x = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14)) +
  labs(linetype = "z_std")
```

